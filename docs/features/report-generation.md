# Report Generation

The Rural Medical AI Kiosk includes a comprehensive report generation system that produces both patient-friendly summaries and formal physician reports.

## Overview

After a consultation is completed, the system can generate two types of reports:

1. **Patient Summary**: Simple, plain-language report for patients
2. **Physician SOAP Report**: Formal medical documentation with ICD-10 codes

Both reports can be viewed in-app or downloaded as professionally formatted PDFs.

## Report Types

### Patient Summary Report

Designed for patients with low health literacy.

**Features:**
- Simple, non-technical language
- Clear action items
- Step-by-step guidance
- Self-care instructions
- Important disclaimers

**Example:**

```
Here is what we found:
You came in because of Red, itchy rash on back.
You can schedule an appointment with a doctor when convenient.

What to do next:
1. Schedule an appointment with a dermatologist within 1-2 weeks
2. Bring this report to your appointment
3. Take photos if the rash changes

In the meantime, you can:
- Keep the affected area clean and dry
- Avoid scratching or picking at the rash
- Use fragrance-free moisturizer
- Wear loose, breathable clothing

Remember: I am not a doctor. This information is to help you,
but please get checked by a real doctor.
```

### Physician SOAP Report

Formal medical documentation following the SOAP framework.

**Features:**
- Complete SOAP structure
- Differential diagnoses with ICD-10 codes
- Confidence scores
- Supporting evidence
- Similar cases from RAG database
- Recommended tests and referrals

**Example:**

```
SUBJECTIVE
==========
Chief Complaint: Red, itchy rash on back
Duration: 3 days

Reported Symptoms:
- Red, itchy rash (3 days)

Medical History: No significant medical history
Allergies: None reported

OBJECTIVE
=========
Primary Location: back
Images Captured: 1
Timestamp: 2024-11-30 17:45:23 UTC

Visual Observations:
- Red, flat patches
- Slightly raised borders
- No blistering

Lesion Characteristics:
  Color: Red
  Texture: Flat patches
  Pattern: scattered on upper back

ASSESSMENT
==========
Differential Diagnoses:

1. Contact Dermatitis (ICD-10: L25.9)
   Confidence: 75%

   Supporting Evidence:
   - Red, itchy rash
   - Flat patches with raised borders
   - Recent onset
   - Improves with cool showers

   Contraindications: None noted

2. Eczema/Atopic Dermatitis (ICD-10: L20.9)
   Confidence: 60%

   Supporting Evidence:
   - Itchy rash
   - Chronic symptoms

   Contraindications:
   - No family history mentioned

3. Fungal Infection/Tinea (ICD-10: B35.9)
   Confidence: 45%

   Supporting Evidence:
   - Raised borders
   - Persistent symptoms

   Contraindications:
   - No scaling mentioned

Overall Assessment:
  Urgency Level: ROUTINE
  Requires Professional Evaluation: Yes
  Overall Confidence: 70%

Reasoning: Non-emergency skin condition that can be evaluated
by a dermatologist at routine appointment

PLAN
====
Patient Guidance:
- Schedule an appointment with a dermatologist within 1-2 weeks
- Bring this report to your appointment
- Take photos if the rash changes

Self-Care Instructions:
- Keep the affected area clean and dry
- Avoid scratching or picking at the rash
- Use fragrance-free moisturizer
- Wear loose, breathable clothing
- Avoid hot showers - use lukewarm water
- Identify and avoid potential irritants

Recommended Diagnostic Tests:
- Skin patch testing
- Fungal culture
- Complete blood count

Follow-up:
Schedule appointment with dermatology within 1-2 weeks

IMPORTANT DISCLAIMER
===================
This report is generated by an AI system and is NOT a medical
diagnosis. It is intended to assist in case history preparation
only. All findings must be verified by a qualified medical
professional. Do not use this report to self-diagnose or
self-treat.
```

## PDF Generation

Reports can be exported as professional PDF documents using ReportLab.

### PDF Features

- **Professional formatting** with headers and footers
- **Page numbering** for multi-page reports
- **Consistent styling** using medical documentation standards
- **Clear section breaks** for easy reading
- **Proper pagination** for long reports

### File Naming

PDFs are automatically named based on report type and consultation ID:

- Patient: `medical-patient-summary-{short_id}.pdf`
- Physician: `medical-physician-report-{short_id}.pdf`

Example: `medical-physician-report-97e13cb5.pdf`

## Frontend Integration

### Report Button

A floating report button appears in the consultation screen when a consultation ID exists:

```typescript
{consultationId && (
  <motion.button
    initial={{ scale: 0 }}
    animate={{ scale: 1 }}
    onClick={() => setShowReportMenu(true)}
    className="absolute top-4 right-4 z-10"
  >
    <FileText className="w-6 h-6" />
  </motion.button>
)}
```

### Report Menu

Clicking the report button opens a menu with two options:

1. **Patient Summary**: For patients and caregivers
2. **Physician Report**: For medical professionals

Each option has two actions:
- **View**: Display formatted report in modal
- **Download**: Generate and download PDF

### Report Viewer Component

The `ReportViewer` component displays formatted text reports:

**Features:**
- Smart text formatting (headers, lists, key-value pairs)
- Responsive design
- Download button integrated
- Professional styling with icons

**Usage:**

```typescript
<ReportViewer
  consultationId={consultationId}
  reportType="patient"
  isOpen={showReportViewer}
  onClose={() => setShowReportViewer(false)}
/>
```

## Backend API

### Generate Text Report

```http
POST /report/patient
Content-Type: application/json

{
  "consultation_id": "uuid",
  "language": "en"
}
```

**Response:**

```json
{
  "consultation_id": "uuid",
  "report_text": "Full formatted report text...",
  "language": "en"
}
```

### Generate PDF Report

```http
GET /report/{consultation_id}/pdf?report_type=patient
```

**Response:**
- Content-Type: `application/pdf`
- Binary PDF data

### API Client Methods

```typescript
// Fetch formatted text report
const response = await getTextReport(consultationId, 'patient');

// Generate and download PDF
const result = await generateAndDownloadPDF(consultationId, 'physician');
if (result.success) {
  console.log('PDF downloaded successfully');
} else {
  console.error('Error:', result.error);
}
```

## Multi-Language Support

Reports can be generated in multiple languages:

| Language | Code | Status |
|----------|------|--------|
| English | en | ✅ Full support |
| Hindi | hi | ✅ Full support |
| Tamil | ta | ✅ Full support |
| Telugu | te | ✅ Full support |
| Bengali | bn | ✅ Full support |

**Usage:**

```json
{
  "consultation_id": "uuid",
  "language": "hi"
}
```

## Testing

### Create Test Consultation

```bash
curl -X POST http://localhost:8000/test/create-sample-consultation
```

Returns:
```json
{
  "status": "created",
  "consultation_id": "97e13cb5-a978-422e-9ed6-fd7074982105",
  "message": "Sample consultation created..."
}
```

### Generate Test Reports

```bash
# Patient report (text)
curl -X POST http://localhost:8000/report/patient \
  -H "Content-Type: application/json" \
  -d '{
    "consultation_id": "97e13cb5-a978-422e-9ed6-fd7074982105",
    "language": "en"
  }'

# Physician report (PDF)
curl -o test-report.pdf \
  http://localhost:8000/report/97e13cb5-a978-422e-9ed6-fd7074982105/pdf

# Verify PDF is valid
file test-report.pdf
# Output: test-report.pdf: PDF document, version 1.4, 1 page(s)
```

## Error Handling

### Common Errors

| Error | Cause | Solution |
|-------|-------|----------|
| 404 Not Found | Consultation doesn't exist | Complete consultation first |
| 400 Bad Request | Incomplete SOAP data | Ensure all SOAP sections are filled |
| 500 Internal Error | PDF generation failed | Check backend logs |

### Frontend Error Messages

The system provides user-friendly error messages:

```typescript
if (error.message.includes('404')) {
  errorText = 'The consultation report is not ready yet. ' +
              'Please complete the consultation first.';
} else if (error.message.includes('500')) {
  errorText = 'There was a problem generating the report. ' +
              'Please try again later.';
}
```

## Data Requirements

For successful report generation, consultations must have:

**Required Fields:**
- `consultation_id`
- `current_stage = COMPLETED`
- `subjective.chief_complaint`
- `assessment.differential_diagnoses` (at least one)
- `plan.patient_guidance`

**Optional but Recommended:**
- `objective.images`
- `objective.visual_observations`
- `assessment.rag_sources`
- `plan.recommended_tests`

## Security Considerations

!!! warning "Sensitive Data"
    Reports contain sensitive medical information:

    - PDFs are generated server-side only
    - No persistent storage of generated PDFs
    - Downloads use temporary blob URLs (auto-revoked)
    - Access control should be implemented
    - HIPAA compliance considerations for production

## Best Practices

1. **Always Complete Consultations**: Don't generate reports for incomplete consultations
2. **Verify Data Quality**: Ensure SOAP sections have meaningful data
3. **Use Appropriate Report Type**: Patient summaries for patients, SOAP reports for providers
4. **Download for Records**: Save PDFs for patient records
5. **Multi-language**: Generate reports in patient's preferred language

## Future Enhancements

- [ ] Email delivery of reports
- [ ] Digital signatures
- [ ] QR codes linking to online reports
- [ ] EMR system integration
- [ ] Report versioning and audit trail
- [ ] Custom templates per facility

---

**See Also:**
- [SOAP Workflow](soap-workflow.md)
- [API Reference](../development/api-reference.md)
- [Testing Guide](../development/testing-guide.md)
